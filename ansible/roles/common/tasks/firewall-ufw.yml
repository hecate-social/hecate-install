---
# UFW firewall configuration

- name: Check if ufw is installed
  command: which ufw
  register: ufw_check
  changed_when: false
  failed_when: false

- name: Configure UFW rules
  when: ufw_check.rc == 0
  block:
    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        comment: 'SSH'

    # Cluster node ports
    - name: Allow Macula mesh
      ufw:
        rule: allow
        port: '4433'
        proto: udp
        comment: 'Macula mesh QUIC'
      when: node_role == 'cluster'

    - name: Allow EPMD (Erlang)
      ufw:
        rule: allow
        port: '4369'
        proto: tcp
        comment: 'EPMD Erlang'
      when: node_role == 'cluster'

    - name: Allow Erlang distribution
      ufw:
        rule: allow
        port: '9100'
        proto: tcp
        comment: 'Erlang distribution'
      when: node_role == 'cluster'

    # Inference node ports
    - name: Allow Ollama API (inference)
      ufw:
        rule: allow
        port: '11434'
        proto: tcp
        comment: 'Ollama API'
      when: node_role == 'inference'
