---
# UFW firewall configuration
#
# UFW defaults to deny-all. We must explicitly allow ports.
# SSH is always opened so Ansible (and admins) can still reach
# the node after the firewall is activated.

- name: Check if ufw is installed
  command: which ufw
  register: ufw_check
  changed_when: false
  failed_when: false

- name: Configure UFW rules
  when: ufw_check.rc == 0
  block:
    # Required for Ansible management access — without this
    # you'd be locked out the moment UFW activates.
    - name: Allow SSH (Ansible management access)
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        comment: 'SSH — Ansible management'

    # Cluster node ports
    - name: Allow Macula mesh
      ufw:
        rule: allow
        port: '4433'
        proto: udp
        comment: 'Macula mesh QUIC'
      when: node_role == 'cluster'

    - name: Allow EPMD (Erlang)
      ufw:
        rule: allow
        port: '4369'
        proto: tcp
        comment: 'EPMD Erlang'
      when: node_role == 'cluster'

    - name: Allow Erlang distribution
      ufw:
        rule: allow
        port: '9100'
        proto: tcp
        comment: 'Erlang distribution'
      when: node_role == 'cluster'

    # Inference node ports
    - name: Allow Ollama API (inference)
      ufw:
        rule: allow
        port: '11434'
        proto: tcp
        comment: 'Ollama API'
      when: node_role == 'inference'
