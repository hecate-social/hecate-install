---
# Firewalld configuration

- name: Check if firewalld is installed
  command: which firewall-cmd
  register: firewalld_check
  changed_when: false
  failed_when: false

- name: Configure firewalld rules
  when: firewalld_check.rc == 0
  block:
    # Cluster node ports
    - name: Allow Macula mesh
      firewalld:
        port: 4433/udp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    - name: Allow EPMD
      firewalld:
        port: 4369/tcp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    - name: Allow Erlang distribution
      firewalld:
        port: 9100/tcp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    # Inference node
    - name: Allow Ollama API
      firewalld:
        port: 11434/tcp
        permanent: yes
        state: enabled
      when: node_role == 'inference'
      notify: reload firewalld
