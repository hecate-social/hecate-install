---
# Firewalld configuration
#
# SSH is always opened so Ansible (and admins) can still reach
# the node after firewalld rules are applied.

- name: Check if firewalld is installed
  command: which firewall-cmd
  register: firewalld_check
  changed_when: false
  failed_when: false

- name: Configure firewalld rules
  when: firewalld_check.rc == 0
  block:
    # Required for Ansible management access
    - name: Allow SSH (Ansible management access)
      firewalld:
        service: ssh
        permanent: yes
        state: enabled
      notify: reload firewalld

    # Cluster node ports
    - name: Allow Macula mesh
      firewalld:
        port: 4433/udp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    - name: Allow EPMD
      firewalld:
        port: 4369/tcp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    - name: Allow Erlang distribution
      firewalld:
        port: 9100/tcp
        permanent: yes
        state: enabled
      when: node_role == 'cluster'
      notify: reload firewalld

    # Inference node
    - name: Allow Ollama API
      firewalld:
        port: 11434/tcp
        permanent: yes
        state: enabled
      when: node_role == 'inference'
      notify: reload firewalld
